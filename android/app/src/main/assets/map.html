<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .leaflet-bar { background-color: white; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); padding: 5px; }
    .leaflet-bar a { background-color: #fff; border-bottom: 1px solid #ccc; text-align: center; width: 30px; height: 30px; line-height: 30px; display: block; color: #000; font-size: 20px; }
    .leaflet-bar a:hover { background-color: #f4f4f4; }
    .leaflet-bar svg { width: 80%; height: 80%; padding: 10%; }
    .leaflet-popup-close-button { display: none; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body>
  <div id="map"></div>
  <script>
    // 전역 변수 선언
    var map;
    var restStops = [];
    var chargingStations = [];
    var campgrounds = [];
    var userLocation = [0, 0];

    var restStopMarkers = L.markerClusterGroup({ chunkedLoading: true, chunkDelay: 50 });
    var chargingStationMarkers = L.markerClusterGroup({ chunkedLoading: true, chunkDelay: 50 });
    var campgroundMarkers = L.markerClusterGroup({ chunkedLoading: true, chunkDelay: 50 });

    var restStopsAdded = false;
    var chargingStationsAdded = false;
    var campgroundsAdded = false;

    // JavaScript 오류 감지 핸들러
    window.onerror = function(message, source, lineno, colno, error) {
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: 'jsError',
        message: message,
        source: source,
        lineno: lineno,
        colno: colno,
        error: error ? error.toString() : '',
      }));
    };

    // React Native로부터 메시지 수신
    document.addEventListener('message', function(event) {
      try {
        var message = JSON.parse(event.data);
        if (message.type === 'initialData') {
          restStops = message.restStops;
          chargingStations = message.chargingStations;
          campgrounds = message.campgrounds;
          userLocation = message.userLocation;

          // 지도 초기화
          initializeMap();
        } else if (message.type === 'toggleRestStops') {
          if (message.show) {
            addRestStopMarkers();
          } else {
            removeRestStopMarkers();
          }
        } else if (message.type === 'toggleChargingStations') {
          if (message.show) {
            addChargingStationMarkers();
          } else {
            removeChargingStationMarkers();
          }
        } else if (message.type === 'toggleCampgrounds') {
          if (message.show) {
            campgrounds = message.data || [];
            addCampgroundMarkers();
          } else {
            removeCampgroundMarkers();
          }
        } else if (message.type === 'resetMap') {
          map.setView(userLocation, 13);
        }
      } catch (error) {
        console.error('React Native로부터 메시지 파싱 오류:', error);
      }
    });

    function initializeMap() {
      map = L.map('map', {
        renderer: L.canvas(),
        zoomControl: false
      }).setView(userLocation, 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      // 파스텔톤 효과 적용
      var style = document.createElement('style');
      style.type = 'text/css';
      style.innerHTML = '.leaflet-tile { filter: saturate(0.7) brightness(1.0) hue-rotate(700deg); }';
      document.getElementsByTagName('head')[0].appendChild(style);

      // 현재 위치 마커
      var userMarker = L.marker(userLocation).addTo(map);
      userMarker.bindPopup('현재 위치').openPopup();

      // 확대/축소 컨트롤 추가
      L.control.zoom({ position: 'bottomright' }).addTo(map);

      // 현재 위치로 이동하는 버튼 추가
      var locateButton = L.control({ position: 'bottomleft' });
      locateButton.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'leaflet-bar');
        div.innerHTML = '<a href="#" title="현재 위치로 이동"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-crosshair"><circle cx="12" cy="12" r="10"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg></a>';
        div.onclick = function() {
          map.setView(userLocation, 13);
        };
        return div;
      };
      locateButton.addTo(map);

      // 지도 이동 이벤트
      map.on('moveend', function() {
        updateVisibleMarkers();
      });

      // 지도 초기화 완료 메시지 전송
      window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'mapReady' }));
    }

    function updateVisibleMarkers() {
      var bounds = map.getBounds();

      if (restStopsAdded) {
        restStopMarkers.clearLayers();
        restStops.forEach(function(stop) {
          var lat = parseFloat(stop.위도);
          var lng = parseFloat(stop.경도);
          if (bounds.contains([lat, lng])) {
            var marker = L.marker([lat, lng]);
            marker.bindPopup(
              (stop.휴게소명 || '이름 정보 없음') + '<br>' +
              (stop.도로종류 || '도로 종류 정보 없음') + '<br>' +
              (stop.휴게소종류 || '종류 정보 없음')
            );
            restStopMarkers.addLayer(marker);
          }
        });
        if (!map.hasLayer(restStopMarkers)) {
          map.addLayer(restStopMarkers);
        }
      }

      if (chargingStationsAdded) {
        chargingStationMarkers.clearLayers();
        chargingStations.forEach(function(station) {
          var lat = parseFloat(station.위도);
          var lng = parseFloat(station.경도);
          if (bounds.contains([lat, lng])) {
            var marker = L.marker([lat, lng]);
            marker.bindPopup(
              (station.충전소명 || '충전소 이름 없음') + '<br>' +
              (station.주소 || '주소 정보 없음') + '<br>' +
              (station.충전기타입 || '타입 정보 없음')
            );
            chargingStationMarkers.addLayer(marker);
          }
        });
        if (!map.hasLayer(chargingStationMarkers)) {
          map.addLayer(chargingStationMarkers);
        }
      }

      if (campgroundsAdded) {
        campgroundMarkers.clearLayers();
        campgrounds.forEach(function(campground, index) {
          var lat = parseFloat(campground.location ? campground.location.lat : campground.latitude);
          var lng = parseFloat(campground.location ? campground.location.lng : campground.longitude);

          if (isNaN(lat) || isNaN(lng)) {
            console.warn('Invalid coordinates for campground:', campground);
            return;
          }

          if (bounds.contains([lat, lng])) {
            var marker = L.marker([lat, lng]);

            // 팝업 콘텐츠 생성
            var popupContent = '';
            if (campground.imageUrl) {
              popupContent += '<img src="' + campground.imageUrl + '" alt="이미지" style="width:100px;height:auto;"><br>';
            } else {
              popupContent += '이미지 URL이 없습니다.<br>';
              popupContent += '<img src="https://via.placeholder.com/100" alt="대체 이미지" style="width:100px;height:auto;"><br>';
            }

            // 이름과 '>>' 기호 표시
            popupContent += '<div style="display: flex; justify-content: space-between; align-items: center;">';
            popupContent += '<b>' + (campground.name || '야영장 이름 없음') + '</b>';
            popupContent += '<b style="float: right;">&gt;&gt;</b>';
            popupContent += '</div>';

            // 팝업 옵션 설정
            var popupOptions = {
              closeButton: false,
            };

            marker.bindPopup(popupContent, popupOptions);

            // 팝업 클릭 이벤트 리스너 추가
            marker.on('popupopen', function(e) {
              var popupNode = e.popup._contentNode;
              if (popupNode) {
                popupNode.style.cursor = 'pointer';
                popupNode.addEventListener('click', function() {
                  window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'campgroundSelected',
                    data: campground
                  }));
                });
              }
            });

            campgroundMarkers.addLayer(marker);
          }
        });

        if (!map.hasLayer(campgroundMarkers)) {
          map.addLayer(campgroundMarkers);
        }

        // 캠핑장 마커 개수 전송
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'markersAdded', count: campgrounds.length }));
      }
    }

    function addRestStopMarkers() {
      if (restStopsAdded) return;
      restStopsAdded = true;
      updateVisibleMarkers();
    }

    function removeRestStopMarkers() {
      if (!restStopsAdded) return;
      map.removeLayer(restStopMarkers);
      restStopMarkers.clearLayers();
      restStopsAdded = false;
    }

    function addChargingStationMarkers() {
      if (chargingStationsAdded) return;
      chargingStationsAdded = true;
      updateVisibleMarkers();
    }

    function removeChargingStationMarkers() {
      if (!chargingStationsAdded) return;
      map.removeLayer(chargingStationMarkers);
      chargingStationMarkers.clearLayers();
      chargingStationsAdded = false;
    }

    function addCampgroundMarkers() {
      if (campgroundsAdded) return;
      campgroundsAdded = true;
      updateVisibleMarkers();
    }

    function removeCampgroundMarkers() {
      if (!campgroundsAdded) return;
      map.removeLayer(campgroundMarkers);
      campgroundMarkers.clearLayers();
      campgroundsAdded = false;
    }
  </script>
</body>
</html>
